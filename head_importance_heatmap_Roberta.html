
<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Head Importance Heatmap</title>
<style>
  body { font-family: system-ui, Segoe UI, Roboto, Arial; margin: 24px; }
  .wrap { display:grid; gap:16px; max-width: 1000px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .card { border:1px solid #eee; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }
  .legend { display:flex; gap:8px; align-items:center; }
  .box { width:16px; height:16px; border-radius:3px; border:1px solid #ddd; }
  .hm { overflow:auto; border:1px solid #eee; border-radius:12px; }
  table.hm { border-collapse: collapse; }
  table.hm td { width:18px; height:18px; padding:0; border: 1px solid #fff; position:relative; }
  td.mark::after { content:''; position:absolute; inset:0; border:3px solid #000; border-radius:3px; } /* marked for removal */
  .muted { color:#666; }
  .chip { padding: 4px 8px; border-radius: 999px; background:#f6f6f6; }
  button { padding:8px 12px; border:1px solid #ddd; background:#fafafa; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Head Importance Heatmap</h1>
  <div class="row">
    <div class="chip">Layers: 24</div>
    <div class="chip">Model: roberta</div>
    <div class="legend">
      <div class="box" style="background:hsl(0, 80%, 60%)"></div><span class="muted">Low</span>
      <div class="box" style="background:hsl(60, 80%, 60%)"></div><span class="muted">Medium</span>
      <div class="box" style="background:hsl(120, 80%, 40%)"></div><span class="muted">High</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>Pruning ratio per layer:
        <input id="ratio" type="range" min="0" max="0.6" step="0.05" value="0.25" style="vertical-align:middle;">
        <span id="ratioVal">25%</span>
      </label>
      <button id="downloadBtn">Download heads_to_prune.json</button>
      <span class="muted">Always mark for removal the heads with the lowest scores in each layer.</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="chip" id="summary"></div>
    </div>
    <div class="hm">
      <table id="heat" class="hm"></table>
    </div>
    <small>Rows = layers (0 at top), columns = heads. Color = importance (green high, red low). Black border = will be pruned.</small>
  </div>
</div>

<script>
const SCORES = {"0": [7.932521820068359, 8.510189056396484, 9.397235870361328, 9.166803359985352, 8.60874080657959, 8.324831008911133, 8.250839233398438, 9.284419059753418, 9.038981437683105, 7.529974937438965, 8.98175048828125, 7.452931880950928, 8.840051651000977, 9.134275436401367, 9.019572257995605, 8.195274353027344], "1": [10.915336608886719, 11.721205711364746, 10.190505027770996, 10.398799896240234, 11.409858703613281, 11.13673210144043, 10.218976974487305, 10.870165824890137, 10.164066314697266, 13.278388977050781, 11.203556060791016, 11.372138977050781, 8.890491485595703, 11.808772087097168, 13.632189750671387, 11.270808219909668], "2": [9.039201736450195, 11.136679649353027, 9.722490310668945, 9.59495735168457, 10.62009334564209, 11.11262035369873, 9.881040573120117, 10.171924591064453, 9.721431732177734, 14.663761138916016, 10.671798706054688, 12.168756484985352, 10.328125, 10.122984886169434, 10.080050468444824, 11.426939964294434], "3": [10.544078826904297, 10.238097190856934, 10.035853385925293, 10.399989128112793, 11.624856948852539, 10.689603805541992, 9.46397876739502, 9.148355484008789, 11.344743728637695, 8.866140365600586, 9.903441429138184, 9.18232250213623, 14.969215393066406, 10.256593704223633, 9.818151473999023, 10.142732620239258], "4": [11.060312271118164, 8.730631828308105, 8.74244499206543, 11.17541790008545, 10.712120056152344, 9.229242324829102, 9.401813507080078, 9.898052215576172, 9.207904815673828, 9.4732027053833, 9.344244956970215, 10.218294143676758, 10.695509910583496, 11.003520011901855, 9.042505264282227, 10.431547164916992], "5": [10.81696891784668, 9.917097091674805, 9.534017562866211, 9.400001525878906, 10.6953125, 11.244888305664062, 11.508031845092773, 9.387748718261719, 9.328254699707031, 10.718070983886719, 9.027589797973633, 10.453956604003906, 10.006237983703613, 11.323946952819824, 9.14863109588623, 10.301488876342773], "6": [11.444831848144531, 9.43574333190918, 10.626120567321777, 10.454791069030762, 8.744284629821777, 11.442192077636719, 10.488348007202148, 12.679508209228516, 9.774286270141602, 9.871535301208496, 9.974405288696289, 9.952415466308594, 9.80754280090332, 12.105127334594727, 12.125057220458984, 10.533082008361816], "7": [9.327554702758789, 10.786447525024414, 8.978996276855469, 9.611194610595703, 11.775168418884277, 11.423017501831055, 11.433172225952148, 11.710498809814453, 11.911626815795898, 10.057018280029297, 10.437762260437012, 9.854013442993164, 12.134979248046875, 10.802684783935547, 10.606831550598145, 12.59449291229248], "8": [10.77199935913086, 9.512261390686035, 11.110269546508789, 10.28141975402832, 12.16029167175293, 11.977778434753418, 9.743291854858398, 11.694025993347168, 10.516369819641113, 10.716936111450195, 11.78259563446045, 9.739618301391602, 9.478971481323242, 12.050658226013184, 10.215113639831543, 11.919858932495117], "9": [9.751260757446289, 10.284872055053711, 11.761503219604492, 10.793586730957031, 10.360773086547852, 10.37516975402832, 11.51197338104248, 10.604146957397461, 10.4613037109375, 11.22212028503418, 12.194453239440918, 11.337076187133789, 10.302000999450684, 10.743762016296387, 13.554178237915039, 10.440141677856445], "10": [10.963788986206055, 10.910334587097168, 11.12597942352295, 12.206210136413574, 11.853835105895996, 11.510516166687012, 11.080900192260742, 11.57539176940918, 15.863321304321289, 9.139274597167969, 10.226950645446777, 10.596166610717773, 10.806396484375, 11.72107219696045, 12.67896842956543, 9.734556198120117], "11": [10.40361213684082, 10.347769737243652, 11.236209869384766, 12.659751892089844, 9.937883377075195, 11.466283798217773, 12.049636840820312, 10.591805458068848, 10.8674955368042, 11.686309814453125, 12.420320510864258, 10.460514068603516, 12.301507949829102, 10.917342185974121, 11.518707275390625, 11.362460136413574], "12": [10.891359329223633, 11.457026481628418, 11.985003471374512, 11.475570678710938, 10.360990524291992, 10.49451732635498, 11.38471794128418, 11.543070793151855, 10.269210815429688, 13.694162368774414, 10.388381958007812, 9.95486831665039, 11.025015830993652, 10.620187759399414, 10.074685096740723, 10.12586784362793], "13": [11.271674156188965, 9.571431159973145, 10.687093734741211, 11.8011474609375, 10.66321086883545, 11.353045463562012, 12.173583984375, 9.922029495239258, 11.49090576171875, 11.632345199584961, 11.81952953338623, 13.738958358764648, 11.18891429901123, 10.586999893188477, 11.900084495544434, 11.827853202819824], "14": [12.839067459106445, 11.850290298461914, 11.249536514282227, 11.120810508728027, 11.146015167236328, 10.941947937011719, 11.425422668457031, 10.178618431091309, 10.284811019897461, 13.536959648132324, 10.753454208374023, 11.267301559448242, 10.65081787109375, 12.327346801757812, 11.364080429077148, 12.49097728729248], "15": [10.634069442749023, 11.547996520996094, 11.495566368103027, 11.630538940429688, 11.617134094238281, 12.13961410522461, 10.90943717956543, 10.899824142456055, 9.830521583557129, 11.433753967285156, 13.328876495361328, 9.8419189453125, 12.181163787841797, 12.184985160827637, 10.169805526733398, 12.612833976745605], "16": [11.98769760131836, 9.49234676361084, 9.690665245056152, 11.338764190673828, 11.492393493652344, 10.081497192382812, 11.058618545532227, 12.235732078552246, 11.095171928405762, 10.962686538696289, 11.651740074157715, 12.249673843383789, 11.676326751708984, 11.248167991638184, 11.441695213317871, 12.39706802368164], "17": [11.806556701660156, 11.813802719116211, 11.421478271484375, 10.561372756958008, 11.678630828857422, 9.765164375305176, 12.019068717956543, 11.456645011901855, 10.15478515625, 11.173784255981445, 11.495229721069336, 12.034553527832031, 11.834693908691406, 10.675743103027344, 12.724371910095215, 11.28187084197998], "18": [11.056436538696289, 11.678202629089355, 11.90089225769043, 11.613581657409668, 11.1343994140625, 10.594289779663086, 12.465205192565918, 12.673439025878906, 11.591876983642578, 10.237150192260742, 11.845495223999023, 11.609121322631836, 11.234755516052246, 11.367350578308105, 11.08614730834961, 10.363330841064453], "19": [12.11246109008789, 10.961237907409668, 12.053487777709961, 11.44119644165039, 10.997843742370605, 10.53638744354248, 10.941474914550781, 10.531432151794434, 11.78848934173584, 11.38470458984375, 10.60336971282959, 11.476591110229492, 10.480650901794434, 10.798041343688965, 10.652464866638184, 11.469462394714355], "20": [10.564642906188965, 10.530717849731445, 10.627331733703613, 10.350122451782227, 10.70751953125, 11.667211532592773, 10.707620620727539, 11.437250137329102, 11.27069091796875, 11.112044334411621, 10.641281127929688, 10.929710388183594, 13.159960746765137, 10.673772811889648, 10.146890640258789, 10.530529022216797], "21": [10.423850059509277, 10.630487442016602, 11.76185417175293, 10.790914535522461, 10.601934432983398, 10.625444412231445, 10.935797691345215, 10.987218856811523, 10.747947692871094, 10.477455139160156, 10.216469764709473, 10.595674514770508, 10.79981517791748, 10.704501152038574, 10.301286697387695, 10.23343563079834], "22": [11.011266708374023, 11.205755233764648, 11.015772819519043, 11.282674789428711, 10.651618003845215, 11.144828796386719, 10.967439651489258, 10.99139404296875, 10.976837158203125, 11.744470596313477, 11.188789367675781, 11.07213020324707, 11.750514030456543, 10.606407165527344, 11.3126220703125, 10.64920711517334], "23": [11.362544059753418, 11.094745635986328, 11.069421768188477, 11.294185638427734, 11.328727722167969, 11.47718334197998, 11.258451461791992, 11.301000595092773, 11.194804191589355, 11.229009628295898, 10.757015228271484, 10.929217338562012, 11.492902755737305, 11.18344497680664, 11.443441390991211, 11.1253080368042]};
const META   = {"model_type": "roberta", "n_layers": 24, "heads_per_layer": {"0": 16, "1": 16, "2": 16, "3": 16, "4": 16, "5": 16, "6": 16, "7": 16, "8": 16, "9": 16, "10": 16, "11": 16, "12": 16, "13": 16, "14": 16, "15": 16, "16": 16, "17": 16, "18": 16, "19": 16, "20": 16, "21": 16, "22": 16, "23": 16}, "note": "Scores are avg L2 of Q/K/V per head (higher = more important)."};

const ratio    = document.getElementById('ratio');
const ratioVal = document.getElementById('ratioVal');
const heat     = document.getElementById('heat');
const summary  = document.getElementById('summary');
const dlBtn    = document.getElementById('downloadBtn');

function colorFor(v, vmin, vmax) {
  // Map red→green without template literals (to avoid conflict with Python f-strings)
  var t = (v - vmin) / Math.max(1e-9, (vmax - vmin));
  var hue = 120 * t; // 0=red, 120=green
  return 'hsl(' + hue + ', 80%, ' + (40 + 20*(1 - t)) + '%)';
}

function build() {
  heat.innerHTML = '';
  var nl = META.n_layers;
  var totalHeads = 0, totalPruned = 0;

  // Global range for all cells (could also be per-layer)
  var globalMin = Infinity, globalMax = -Infinity;
  for (const li in SCORES) {
    for (const s of SCORES[li]) {
      if (s < globalMin) globalMin = s;
      if (s > globalMax) globalMax = s;
    }
  }

  var r = parseFloat(ratio.value);
  ratioVal.textContent = Math.round(r*100) + '%';

  for (var li=0; li<nl; li++) {
    var row = document.createElement('tr');
    var scores = SCORES[li];
    if (!scores) continue;

    var H = scores.length;
    var k = Math.max(0, Math.min(H, Math.round(H * r)));
    totalHeads += H;

    // Indices by ascending value
    var order = scores.map(function(v,idx){return [v,idx];}).sort(function(a,b){return a[0]-b[0];}).map(function(x){return x[1];});
    var toPrune = new Set(order.slice(0, k));
    totalPruned += k;

    for (var h=0; h<H; h++) {
      var td = document.createElement('td');
      td.style.background = colorFor(scores[h], globalMin, globalMax);
      if (toPrune.has(h)) td.classList.add('mark');
      td.title = 'layer ' + li + ', head ' + h + ', score ' + scores[h].toFixed(4) + (toPrune.has(h) ? ' (PRUNE)' : ' (KEEP)');
      row.appendChild(td);
    }
    heat.appendChild(row);
  }

  summary.textContent = 'Total heads: ' + totalHeads + ' | To prune by ratio: ' + totalPruned;
}

function download() {
  var nl = META.n_layers;
  var r = parseFloat(ratio.value);
  var out = {};
  for (var li=0; li<nl; li++) {
    var scores = SCORES[li];
    if (!scores) continue;
    var H = scores.length;
    var k = Math.max(0, Math.min(H, Math.round(H * r)));
    if (k === 0) continue;
    var order = scores.map(function(v,idx){return [v,idx];}).sort(function(a,b){return a[0]-b[0];}).map(function(x){return x[1];});
    out[li] = Array.from(order.slice(0, k));
  }
  var blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'heads_to_prune.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

ratio.addEventListener('input', build);
dlBtn.addEventListener('click', download);
build();
</script>
</body>
</html>
